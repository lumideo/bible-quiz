<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>초등2부 성경퀴즈</title>
  <style>
    body { font-family: sans-serif; background:#f7f7fa; }
    .container { max-width: 800px; margin: 20px auto; }
    .card { background:white; border-radius:10px; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-top:20px; }
    button { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
    .btn { background:#4a67f5; color:white; margin:5px; }
    .btn:hover { opacity:0.85; }
    .wrong { color:red; font-weight:bold; }
    .correct { color:green; font-weight:bold; }
    .hint { margin-top:10px; font-size:14px; color:#555; }
  </style>
</head>
<body>
  <div class="container">
    <h1>초등2부 성경퀴즈</h1>
    <p>얘들아 문제를 풀어 볼까?</p>
    <button onclick="startPractice()" class="btn">연습문제</button>
    <button onclick="startTest()" class="btn">실전문제</button>

    <div id="quizArea" class="card" style="display:none;">
      <div id="modeLabel"></div>
      <div id="questionText"></div>
      <div id="choices"></div>
      <input type="text" id="answerInput" placeholder="정답을 입력하세요" style="width:100%;padding:8px;margin-top:10px;display:none;">
      <div style="margin-top:10px;">
        <button onclick="showHint()" class="btn" id="hintBtn">힌트 보기</button>
        <button onclick="submitAnswer()" class="btn" id="submitBtn">제출하기</button>
        <button onclick="nextQuestion()" class="btn" id="nextBtn" style="display:none;">다음 문제</button>
      </div>
      <div id="result" style="margin-top:10px;"></div>
      <div id="hintArea" class="hint"></div>
    </div>
  </div>

  <!-- 사운드 -->
  <audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
  <audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

  <script src="questions.js"></script>
  <script>
    let questions = window.quizQuestions || [];
    let mode = "practice";
    let current = 0;
    let score = 0;

    function startPractice(){
      mode="practice"; current=0; score=0;
      document.getElementById("quizArea").style.display="block";
      showQuestion();
    }
    function startTest(){
      mode="test"; current=0; score=0;
      document.getElementById("quizArea").style.display="block";
      showQuestion();
    }

    function showQuestion(){
      const q = questions[current];
      document.getElementById("modeLabel").innerText = (mode==="practice"?"연습모드":"실전모드") + " · 문제 " + (current+1) + " / " + questions.length;
      document.getElementById("questionText").innerText = q.q;
      document.getElementById("result").innerHTML="";
      document.getElementById("hintArea").innerHTML="";
      document.getElementById("nextBtn").style.display="none";
      document.getElementById("hintBtn").style.display=(q.type==="fill")?"inline-block":"none";

      if(q.type==="mc"){
        document.getElementById("answerInput").style.display="none";
        let html="";
        q.choices.forEach((c,i)=>{
          html += `<div><label><input type="radio" name="choice" value="${i}"> ${c}</label></div>`;
        });
        document.getElementById("choices").innerHTML=html;
      } else {
        document.getElementById("answerInput").style.display="block";
        document.getElementById("answerInput").value="";
        document.getElementById("choices").innerHTML="";
      }
    }

    function showHint(){
      const q=questions[current];
      if(q.hint) document.getElementById("hintArea").innerText="힌트 : "+q.hint;
      else document.getElementById("hintArea").innerText="힌트 없음";
    }

    function norm(s){ return s.toString().trim().toLowerCase(); }
    function stripSpaces(s){ return s.replace(/\s+/g,""); }

    // 숫자 붙여쓰기 방지
    function includesWithBoundary(hay, needle){
      if (!needle) return false;
      if (/^[0-9]+$/.test(String(needle))){
        const re=new RegExp(`(?<!\\d)${needle}(?!\\d)`);
        return re.test(hay);
      }
      return hay.includes(needle);
    }

    function checkFill(userText, q){
      const raw=q.ignoreSpaces?stripSpaces(userText):userText;
      const t=norm(raw);

      if(q.mode==="contains"||q.contains){
        const c=q.contains||{};
        const prep=s=>norm(q.ignoreSpaces?stripSpaces(String(s)):String(s));

        if(Array.isArray(c.all)&&c.all.length){
          for(const k of c.all){
            if(!includesWithBoundary(t,prep(k))) return false;
          }
          return true;
        }
        if(Array.isArray(c.any)&&c.any.length){
          return c.any.some(k=>includesWithBoundary(t,prep(k)));
        }
      }

      const list=Array.isArray(q.answers)?q.answers:(Array.isArray(q.answer)?q.answer:null);
      if(list){
        return list.some(ans=>{
          const key=norm(q.ignoreSpaces?stripSpaces(String(ans)):String(ans));
          return t===key;
        });
      }
      return false;
    }

    function submitAnswer(){
      const q=questions[current];
      let correct=false;
      if(q.type==="mc"){
        const sel=document.querySelector("input[name=choice]:checked");
        if(sel && parseInt(sel.value)===q.answerIndex) correct=true;
      } else {
        const val=document.getElementById("answerInput").value;
        if(checkFill(val,q)) correct=true;
      }

      if(correct){
        document.getElementById("result").innerHTML="<span class='correct'>딩동댕! 정답입니다</span>";
        document.getElementById("audio-correct").play();
        score++;
        if(mode==="practice"){
          // 연습: 정답이면 바로 다음 문제
          current++;
          if(current<questions.length) setTimeout(showQuestion,600);
          else endQuiz();
        } else {
          // 실전: 바로 넘어감
          current++;
          if(current<questions.length) showQuestion(); else endQuiz();
        }
      } else {
        document.getElementById("result").innerHTML="<span class='wrong'>땡! 다시 시도해 보자.</span>";
        document.getElementById("audio-wrong").play();
        if(mode==="practice"){
          // 연습: 오답이면 다음문제 버튼
          document.getElementById("nextBtn").style.display="inline-block";
        } else {
          // 실전: 바로 넘어감
          current++;
          if(current<questions.length) showQuestion(); else endQuiz();
        }
      }
    }

    function nextQuestion(){
      current++;
      if(current<questions.length) showQuestion(); else endQuiz();
    }

    function endQuiz(){
      document.getElementById("quizArea").innerHTML=`<h2>퀴즈 종료!</h2><p>점수: ${score} / ${questions.length}</p>`;
    }
  </script>
</body>
</html>
