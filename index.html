<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>초등2부 성경퀴즈</title>
<style>
  :root{
    --bg:#f7f7fb;
    --card:#ffffff;
    --text:#222;
    --muted:#666;
    --brand:#4f46e5;
    --ok:#22c55e;
    --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:880px;margin:24px auto;padding:16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.07);padding:20px}
  h1{margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-size:16px;cursor:pointer;background:#eee}
  .btn-brand{background:var(--brand);color:#fff}
  .btn-plain{background:#ececf3}
  .btn-ok{background:var(--ok);color:#fff}
  .btn-bad{background:var(--bad);color:#fff}
  .hidden{display:none !important}
  .qbox{font-size:20px;line-height:1.5;margin:10px 0 14px}
  .progress{color:var(--muted);font-size:14px;margin-bottom:8px}
  .choices{display:grid;gap:10px;margin:10px 0}
  .choice{padding:12px 14px;border-radius:12px;border:1px solid #ddd;background:#fafafa;text-align:left}
  .choice input{margin-right:8px}
  .ans-row{display:flex;gap:12px;align-items:center}
  input[type="text"]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #d7d7e0;background:#fff;font-size:16px}
  .hint{border-left:4px solid #ffd54f;background:#fff7cc;padding:10px 12px;border-radius:8px;margin-top:10px;color:#5f4b00}
  .result{margin-top:10px;font-weight:700}
  .result.ok{color:var(--ok)}
  .result.bad{color:var(--bad)}
  .footer{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap}
  .center{display:flex;justify-content:center;align-items:center;gap:10px}
</style>
</head>
<body>
<div class="wrap">
  <!-- 메인 -->
  <div id="screen-home" class="card">
    <h1>초등2부 성경퀴즈</h1>
    <p class="sub">얘들아 문제를 풀어 볼까요?</p>
    <div class="row">
      <button class="btn-brand" id="btn-practice">연습문제</button>
      <button class="btn-plain" id="btn-exam">실전문제</button>
    </div>
    <p class="sub" style="margin-top:14px">※ 총 70문제 중 매회 <b>무작위 25문제</b>가 출제돼요.</p>
  </div>

  <!-- 퀴즈 -->
  <div id="screen-quiz" class="card hidden">
    <div class="progress" id="progress"></div>
    <div id="q-number" class="sub"></div>
    <div class="qbox" id="q-text"></div>

    <!-- 객관식 -->
    <div id="area-mc" class="choices hidden"></div>

    <!-- 주관식 -->
    <div id="area-fill" class="hidden">
      <div class="ans-row">
        <input id="answer" type="text" placeholder="정답을 입력하세요" autocomplete="off" />
        <button id="btn-hint" class="btn-plain">힌트</button>
        <button id="btn-submit" class="btn-brand">제출하기</button>
      </div>
      <div id="hint-area" class="hint hidden"></div>
    </div>

    <div id="result" class="result"></div>

    <div class="footer">
      <button id="btn-next" class="btn-plain hidden">다음 문제</button>
      <button id="btn-exit" class="btn-plain">나가기</button>
    </div>
  </div>

  <!-- 종료 -->
  <div id="screen-end" class="card hidden">
    <h2 id="end-title">수고했습니다 ♥</h2>
    <p class="sub" id="end-sub"></p>
    <div class="row">
      <button id="btn-retry" class="btn-brand">다시 도전</button>
      <button id="btn-home" class="btn-plain">처음으로</button>
    </div>
  </div>
</div>

<!-- 사운드 -->
<audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
<audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

<script>
/* ====== 설정 ====== */
const NUM_PER_ROUND = 25;
const MODE_PRACTICE = 'practice';
const MODE_EXAM     = 'exam';

// 볼륨 (필요 시 여기서 조절)
const VOLUME_CORRECT = 0.95; // 딩동댕
const VOLUME_WRONG   = 0.95; // 땡

/* ====== 상태 ====== */
let ALL = [];               // 전체 70문제
let round = [];             // 이번 라운드 25문제
let qi = 0;                 // 라운드 내 인덱스
let mode = MODE_PRACTICE;   // 현재 모드
let score = 0;              // 실전 점수(백점 환산용 4점씩 가정: 25*4=100)
let correctCount = 0;       // 맞춘 개수(둘 다에서 사용)
let current = null;         // 현재 문제
let shuffledChoices = [];   // 보기 셔플

/* ====== 유틸 ====== */
function shuffle(a){
  const arr = a.slice();
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function norm(s){ return (s||'').toString().trim(); }

// 낱말 경계 정규식: 숫자는 \b, 문자/한글은 양옆이 문자/숫자/한글이 아닌 경우
function buildBoundaryRegex(key){
  const esc = key.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  if (/^\d+$/.test(key)) return new RegExp(`\\b${esc}\\b`, 'i');
  return new RegExp(`(?<![0-9A-Za-z가-힣])${esc}(?![0-9A-Za-z가-힣])`,'i');
}

// 주관식 contains 판정 (all/any 지원, 없으면 answers 정확일치)
function checkContains(userText, q){
  const t = norm(userText);
  const c = q.contains || {};
  const all = Array.isArray(c.all) ? c.all : [];
  const any = Array.isArray(c.any) ? c.any : [];

  if (all.length){
    for (const k of all){
      const rx = buildBoundaryRegex(String(k));
      if (!rx.test(t)) return false;
    }
    return true;
  }
  if (any.length){
    for (const k of any){
      const rx = buildBoundaryRegex(String(k));
      if (rx.test(t)) return true;
    }
    return false;
  }

  // contains 미지정 → answers로 정확일치 (공백무시)
  if (Array.isArray(q.answers)){
    const nt = t.replace(/\s+/g,'').toLowerCase();
    for (const ans of q.answers){
      const na = String(ans).replace(/\s+/g,'').toLowerCase();
      if (nt === na) return true;
    }
  }
  return false;
}

/* ====== 화면 전환 ====== */
const $home  = document.getElementById('screen-home');
const $quiz  = document.getElementById('screen-quiz');
const $end   = document.getElementById('screen-end');

function show(id){
  $home.classList.add('hidden');
  $quiz.classList.add('hidden');
  $end.classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

/* ====== 오디오 ====== */
const auOK = document.getElementById('audio-correct');
const auNG = document.getElementById('audio-wrong');
auOK.volume = VOLUME_CORRECT;
auNG.volume = VOLUME_WRONG;

/* ====== 문제 로딩 ====== */
async function loadQuestions(){
  const res = await fetch('questions.json?v=' + Date.now()); // 캐시무효화
  ALL = await res.json();
}

function startRound(m){
  mode = m;
  const pool = shuffle(ALL);
  round = pool.slice(0, NUM_PER_ROUND);
  qi = 0;
  score = 0;
  correctCount = 0;
  show('screen-quiz');
  renderQuestion();
}

function renderQuestion(){
  current = round[qi];

  // UI 요소
  const $progress = document.getElementById('progress');
  const $num  = document.getElementById('q-number');
  const $q    = document.getElementById('q-text');
  const $mc   = document.getElementById('area-mc');
  const $fill = document.getElementById('area-fill');
  const $ans  = document.getElementById('answer');
  const $hintBtn  = document.getElementById('btn-hint');
  const $hintArea = document.getElementById('hint-area');
  const $result = document.getElementById('result');
  const $next   = document.getElementById('btn-next');

  $progress.textContent = `진행: ${qi+1} / ${NUM_PER_ROUND}  ·  모드: ${mode==='practice'?'연습':'실전'}`;
  $num.textContent = `문제 ${current.id}번`;
  $q.textContent = current.q;
  $result.textContent = '';
  $result.className = 'result';
  $next.classList.add('hidden');

  // 힌트 영역 초기화
  $hintArea.textContent = '';
  $hintArea.classList.add('hidden');

  if (current.type === 'mc'){
    $mc.classList.remove('hidden');
    $fill.classList.add('hidden');
    $mc.innerHTML = '';

    shuffledChoices = shuffle(current.choices.map((txt, idx)=>({txt, idx})));

    shuffledChoices.forEach((c,i)=>{
      const id = `opt-${i}`;
      const item = document.createElement('label');
      item.className = 'choice';
      item.innerHTML = `<input type="radio" name="opt" value="${c.idx}" /> ${c.txt}`;
      $mc.appendChild(item);
    });

  } else {
    $mc.classList.add('hidden');
    $fill.classList.remove('hidden');
    $ans.value = '';
  }
}

function playOK(){ auOK.currentTime = 0; auOK.play().catch(()=>{}); }
function playNG(){ auNG.currentTime = 0; auNG.play().catch(()=>{}); }

/* ====== 채점 ====== */
function checkMC(q){
  const checked = document.querySelector('input[name="opt"]:checked');
  if (!checked) return null; // 미선택
  const pickedIndex = parseInt(checked.value,10);
  return pickedIndex === q.answerIndex;
}

function onSubmit(){
  const $result = document.getElementById('result');
  const $next   = document.getElementById('btn-next');
  let isCorrect = false;

  if (current.type === 'mc'){
    const res = checkMC(current);
    if (res === null){
      // 연습/실전 모두 선택 유도
      $result.textContent = '보기 하나를 선택해 주세요.';
      $result.className = 'result';
      return;
    }
    isCorrect = res;
  } else {
    const val = document.getElementById('answer').value || '';
    isCorrect = checkContains(val, current);
  }

  if (isCorrect){
    $result.textContent = '딩동댕! 정답입니다.';
    $result.className = 'result ok';
    playOK();
    correctCount++;
    if (mode === MODE_EXAM){ score += 4; } // 25문제 *4 = 100점

    if (mode === MODE_PRACTICE){
      // 연습: 정답이면 자동 다음, "다음 문제" 버튼은 숨김
      document.getElementById('btn-next').classList.add('hidden');
      setTimeout(goNext, 450);
    } else {
      // 실전: 정답/오답 모두 자동 다음
      setTimeout(goNext, 350);
    }

  } else {
    $result.textContent = '땡! 틀렸어요.';
    $result.className = 'result bad';
    playNG();

    if (mode === MODE_PRACTICE){
      // 연습: 오답이면 다음 버튼 노출
      document.getElementById('btn-next').classList.remove('hidden');
    } else {
      // 실전: 오답이어도 자동 다음
      setTimeout(goNext, 450);
    }
  }
}

function goNext(){
  qi++;
  if (qi >= NUM_PER_ROUND){
    endRound();
  } else {
    renderQuestion();
  }
}

function endRound(){
  show('screen-end');
  const $title = document.getElementById('end-title');
  const $sub   = document.getElementById('end-sub');
  if (mode === MODE_PRACTICE){
    $title.textContent = '수고했습니다 ♥';
    $sub.textContent = `맞춘 개수: ${correctCount} / ${NUM_PER_ROUND}`;
  } else {
    $title.textContent = '실전 결과';
    $sub.textContent = `점수: ${score}점 (맞춘 개수 ${correctCount} / ${NUM_PER_ROUND})`;
  }
}

/* ====== 힌트 ====== */
function onClickHint(){
  const $hint = document.getElementById('hint-area');
  const txt = (current && typeof current.hint === 'string' && current.hint.trim())
    ? current.hint
    : '힌트 없음';
  $hint.textContent = txt;
  $hint.classList.remove('hidden');
}

/* ====== 이벤트 바인딩 ====== */
document.getElementById('btn-practice').addEventListener('click', ()=> startRound(MODE_PRACTICE));
document.getElementById('btn-exam').addEventListener('click',     ()=> startRound(MODE_EXAM));

document.getElementById('btn-submit').addEventListener('click', onSubmit);
document.getElementById('btn-next').addEventListener('click',   goNext);
document.getElementById('btn-hint').addEventListener('click',   onClickHint);

document.getElementById('btn-exit').addEventListener('click',   ()=> show('screen-home'));
document.getElementById('btn-retry').addEventListener('click',  ()=> startRound(mode));
document.getElementById('btn-home').addEventListener('click',   ()=> show('screen-home'));

/* ====== 시작 ====== */
loadQuestions().then(()=>{ /* 로딩 완료 후 대기 */ });
</script>
</body>
</html>
