<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>초등2부 성경퀴즈</title>
  <style>
    :root {
      --bg:#f8fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --brand:#284BA0;
      --ok:#16a34a; --bad:#dc2626;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .wrap{max-width:840px;margin:40px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:24px;}
    h1{margin:0 0 6px;font-size:28px}
    .sub{color:var(--muted);margin-bottom:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1f2937}
    .btn.small{padding:8px 12px;font-weight:600}
    .muted{color:var(--muted)}
    .qno{font-weight:700;color:var(--brand)}
    .qtext{font-size:20px;margin:10px 0 16px}
    .choices{display:grid;gap:10px}
    .choice{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;cursor:pointer}
    .choice input{margin-right:8px}
    .answerBox{display:flex;gap:10px;margin:8px 0 0}
    input[type="text"]{flex:1;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
    .hint{background:#fffbe6;border:1px dashed #f59e0b;color:#92400e;border-radius:10px;padding:10px 12px;margin-top:10px;display:none}
    .status{margin-top:12px;font-weight:700}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:var(--brand);width:0%}
    .footer{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
    .center{text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="screen-home" class="card">
      <h1>초등2부 성경퀴즈</h1>
      <div class="sub">얘들아 문제를 풀어 볼까요?</div>
      <div class="row">
        <button class="btn primary" id="btn-practice">연습문제</button>
        <button class="btn ghost" id="btn-exam">실전문제</button>
      </div>
      <p class="muted" style="margin-top:14px">
        전체 70문제 중 매번 <b>랜덤 25문제</b>가 출제돼요. (재도전할 때마다 새로 섞여요!)
      </p>
    </div>

    <div id="screen-quiz" class="card" style="display:none">
      <div class="topbar">
        <div>
          <div><span id="modeTag" class="muted"></span></div>
          <div><span class="qno" id="qno">1 / 25</span></div>
        </div>
        <button class="btn small ghost" id="btn-exit">처음으로</button>
      </div>
      <div class="progress"><div id="bar"></div></div>

      <div id="qwrap">
        <div class="qtext" id="qtext">문제 텍스트</div>
        <div id="mc-wrap" class="choices"></div>

        <div id="fill-wrap" style="display:none">
          <div class="answerBox">
            <input id="fill-input" type="text" placeholder="정답을 입력해요" autocomplete="off" />
            <button class="btn small ghost" id="btn-hint">힌트</button>
          </div>
          <div id="hint" class="hint"></div>
        </div>

        <div class="footer">
          <button class="btn primary" id="btn-submit">제출하기</button>
          <button class="btn ghost" id="btn-skip" style="display:none">다음 문제</button>
        </div>

        <div id="status" class="status"></div>
      </div>
    </div>

    <div id="screen-finish" class="card center" style="display:none">
      <h1 id="finish-title">수고했습니다♥</h1>
      <p id="finish-desc" class="sub"></p>
      <div class="row" style="justify-content:center">
        <button class="btn primary" id="btn-retry-practice">연습 다시</button>
        <button class="btn ghost" id="btn-retry-exam">실전 다시</button>
        <button class="btn ghost" id="btn-home">처음으로</button>
      </div>
    </div>
  </div>

  <!-- 사운드 (동일 폴더에 mp3 배치) -->
  <audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
  <audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

  <!-- 안전장치: 로드 실패 시 사용할 샘플 3문항 -->
  <script id="questionsData" type="application/json">[
    { "id": 1, "type": "fill", "q": "창세기 1장 1절: 태초에 하나님이 (      )과 (      )을 창조하시니라",
      "hint": "둘 다 자연입니다. 공백/조사 무시", "ignoreSpaces": true,
      "answers": ["하늘과땅","하늘 땅","하늘과 땅"] },
    { "id": 2, "type": "mc", "q": "예수님의 제자는 몇 명이었나요?",
      "choices": ["10명","12명","70명","3명"], "answerIndex": 1 },
    { "id": 3, "type": "mc", "q": "다윗이 물리친 거인의 이름은?",
      "choices": ["골리앗","바알","느부갓네살","사울"], "answerIndex": 0 }
  ]</script>

  <script>
    const FILE_URL = "questions_tuned_70.json"; // 같은 폴더에 두기
    let ALL = [];          // 전체 문제(70)
    let PICK = [];         // 뽑힌 25
    let MODE = null;       // 'practice' | 'exam'
    let idx = 0;           // 현재 인덱스(0~24)
    let score = 0;         // 실전 점수
    const TOTAL = 25;

    // UI refs
    const home = document.getElementById('screen-home');
    const quiz = document.getElementById('screen-quiz');
    const done = document.getElementById('screen-finish');
    const qnoEl = document.getElementById('qno');
    const qtextEl = document.getElementById('qtext');
    const mcWrap = document.getElementById('mc-wrap');
    const fillWrap = document.getElementById('fill-wrap');
    const fillInput = document.getElementById('fill-input');
    const hintBtn = document.getElementById('btn-hint');
    const hintBox = document.getElementById('hint');
    const submitBtn = document.getElementById('btn-submit');
    const skipBtn = document.getElementById('btn-skip');
    const statusEl = document.getElementById('status');
    const bar = document.getElementById('bar');
    const modeTag = document.getElementById('modeTag');
    const finishTitle = document.getElementById('finish-title');
    const finishDesc = document.getElementById('finish-desc');

    const audioOK = document.getElementById('audio-correct');
    const audioNO = document.getElementById('audio-wrong');

    // 초기 로드
    (async function init(){
      ALL = await loadQuestions();
      attachEvents();
    })();

    async function loadQuestions(){
      try{
        const res = await fetch(FILE_URL, {cache:"no-store"});
        if(!res.ok) throw new Error("fetch failed");
        const data = await res.json();
        // 기본 유효성(최소 필드) 체크
        return Array.isArray(data) && data.length ? data : fallback();
      }catch(e){
        console.warn("문제 파일 로드 실패 → 샘플 사용", e);
        return fallback();
      }
    }
    function fallback(){
      const raw = document.getElementById('questionsData').textContent;
      return JSON.parse(raw);
    }

    function attachEvents(){
      document.getElementById('btn-practice').onclick = () => start('practice');
      document.getElementById('btn-exam').onclick = () => start('exam');
      document.getElementById('btn-exit').onclick = () => show('home');

      document.getElementById('btn-retry-practice').onclick = () => start('practice');
      document.getElementById('btn-retry-exam').onclick = () => start('exam');
      document.getElementById('btn-home').onclick = () => show('home');

      submitBtn.onclick = onSubmit;
      skipBtn.onclick = nextQuestion;
      hintBtn.onclick = () => hintBox.style.display = hintBox.style.display==='none'?'block':'none';

      // 엔터키 제출
      fillInput.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ onSubmit(); }
      });
    }

    function show(which){
      home.style.display = which==='home' ? 'block' : 'none';
      quiz.style.display = which==='quiz' ? 'block' : 'none';
      done.style.display = which==='done' ? 'block' : 'none';
    }

    function start(mode){
      MODE = mode;
      score = 0;
      idx = 0;
      PICK = pickRandom(ALL, TOTAL); // 매번 새로 섞기
      modeTag.textContent = (MODE==='practice') ? '연습모드' : '실전모드';
      show('quiz');
      render();
    }

    function pickRandom(arr, n){
      const copy = [...arr];
      // 피셔-예이츠
      for(let i=copy.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [copy[i],copy[j]]=[copy[j],copy[i]];
      }
      return copy.slice(0, Math.min(n, copy.length));
    }

    function render(){
      const q = PICK[idx];
      // 상단
      qnoEl.textContent = `${idx+1} / ${TOTAL}`;
      bar.style.width = `${((idx)/TOTAL)*100}%`;
      statusEl.textContent = '';

      // 본문
      qtextEl.textContent = q.q;
      hintBox.style.display = 'none';
      hintBox.textContent = q.hint || '';

      // 타입별 UI
      if(q.type === 'mc'){
        fillWrap.style.display = 'none';
        mcWrap.style.display = 'grid';
        mcWrap.innerHTML = '';
        (q.choices||[]).forEach((c,i)=>{
          const id = `ch-${i}`;
          const div = document.createElement('label');
          div.className = 'choice';
          div.innerHTML = `<input type="radio" name="mc" value="${i}" id="${id}"><span>${c}</span>`;
          mcWrap.appendChild(div);
        });
        skipBtn.style.display = (MODE==='exam') ? 'none' : 'none'; // 연습도 건너뛰기 없음
      }else{
        mcWrap.style.display = 'none';
        fillWrap.style.display = 'block';
        fillInput.value = '';
        skipBtn.style.display = (MODE==='exam') ? 'none' : 'none';
      }

      // 버튼 상태
      submitBtn.disabled = false;
    }

    function onSubmit(){
      const q = PICK[idx];
      const correct = checkAnswer(q);
      if (correct){
        audioOK.currentTime=0; audioOK.play().catch(()=>{});
        statusEl.innerHTML = `<span class="ok">딩동댕! 정답이에요</span>`;
        if(MODE==='exam'){ score++; autoNext(); }
        else{ // practice: 정답이어야 다음으로
          setTimeout(nextQuestion, 450);
        }
      }else{
        audioNO.currentTime=0; audioNO.play().catch(()=>{});
        statusEl.innerHTML = `<span class="bad">땡! 다시 시도해봐요</span>`;
        if(MODE==='exam'){ // 틀려도 바로 다음으로
          autoNext();
        }else{
          // 연습: 같은 문제 계속
          // 주관식이면 힌트 자동 열기
          if(q.type!=='mc' && q.hint){
            hintBox.style.display='block';
          }
        }
      }
    }

    function autoNext(){
      submitBtn.disabled = true;
      setTimeout(nextQuestion, 450);
    }

    function nextQuestion(){
      if(idx < TOTAL-1){
        idx++;
        render();
      }else{
        finish();
      }
    }

    function finish(){
      show('done');
      bar.style.width = '100%';
      if(MODE==='practice'){
        finishTitle.textContent = '수고했습니다♥';
        finishDesc.textContent = '연습문제를 모두 풀었어요. 또 해볼래요?';
      }else{
        finishTitle.textContent = '실전 결과';
        finishDesc.innerHTML = `총점: <b>${score} / ${TOTAL}</b> 점`;
      }
    }

    // 정답 판정
    function normalize(s, ignoreSpaces){
      if(typeof s !== 'string') return '';
      let t = s.trim().toLowerCase();
      if(ignoreSpaces) t = t.replace(/\s+/g,'');
      // 한글 받침/자모 분리까지는 과하지 않게끔 처리
      return t;
    }

    function checkAnswer(q){
      if(q.type==='mc'){
        const sel = document.querySelector('input[name="mc"]:checked');
        if(!sel) return false;
        const idxSel = Number(sel.value);
        return idxSel === Number(q.answerIndex);
      }else{
        const user = normalize(fillInput.value, !!q.ignoreSpaces);
        if(!user) return false;
        const list = Array.isArray(q.answers) ? q.answers : [];
        return list.some(ans => normalize(String(ans), !!q.ignoreSpaces) === user);
      }
    }
  </script>
</body>
</html>
