<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>초등2부 성경퀴즈</title>
  <style>
    :root{
      --brand:#5b6dff;
      --ok:#16a34a;
      --bad:#ef4444;
      --card:#ffffff;
      --bg:#f6f7fb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{background:linear-gradient(180deg,#eef1ff,transparent);border-radius:16px;padding:20px 24px;margin-bottom:20px}
    h1{margin:0 0 8px 0;font-size:28px}
    .sub{margin:0;color:#6b7280}
    .modes{display:flex;gap:12px;margin-top:16px}
    .modes button{padding:10px 18px;border:0;border-radius:10px;background:#e7e9ff;color:#111;font-weight:600;cursor:pointer}
    .modes button.primary{background:var(--brand);color:#fff}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px}
    .hide{display:none !important}
    .row{margin:10px 0}
    .progress{color:#6b7280;font-size:14px}
    .q{font-size:20px;line-height:1.5;margin:8px 0 10px}
    .choices label{display:block;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;margin:8px 0;cursor:pointer}
    .choices input{margin-right:8px}
    .input{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#eef2ff}
    .btn.gray{background:#eceff3}
    .status{min-height:24px;margin-top:8px;font-weight:700}
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .center{text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1>초등2부 성경퀴즈</h1>
      <p class="sub">얘들아 문제를 풀어 볼까요?</p>
      <div class="modes">
        <button id="btnPractice" class="btn primary">연습문제</button>
        <button id="btnTest" class="btn">실전문제</button>
      </div>
    </header>

    <section id="quizCard" class="card hide">
      <div class="progress" id="progress"></div>
      <div class="q" id="question"></div>

      <div id="choices" class="choices"></div>
      <input id="answer" class="input hide" type="text" placeholder="정답을 입력하세요" autocomplete="off"/>

      <div class="actions">
        <button id="btnHint" class="btn ghost hide">힌트 보기</button>
        <button id="btnSubmit" class="btn primary">제출하기</button>
        <button id="btnNext" class="btn gray hide">다음 문제</button>
      </div>
      <div id="hint" class="row hide"></div>
      <div id="status" class="status"></div>
    </section>

    <section id="finalCard" class="card center hide">
      <h2 id="finalTitle"></h2>
      <p id="finalBody"></p>
      <div class="actions center" style="justify-content:center">
        <button id="btnHome" class="btn ghost">처음으로</button>
      </div>
    </section>
  </div>

  <!-- 사운드 -->
  <audio id="sCorrect" src="dingdong.mp3" preload="auto"></audio>
  <audio id="sWrong"   src="ddang.mp3"    preload="auto"></audio>

  <script>
  // ===== 설정 =====
  const PICK_COUNT = 25;           // 매 세션 랜덤 25문제
  const VOL_CORRECT = 1.0;         // 정답 사운드 볼륨
  const VOL_WRONG   = 0.95;        // 오답 사운드 볼륨
  // =================

  // 엘리먼트
  const el = {
    qCard: byId('quizCard'),
    fCard: byId('finalCard'),
    btnPractice: byId('btnPractice'),
    btnTest: byId('btnTest'),
    progress: byId('progress'),
    question: byId('question'),
    choices: byId('choices'),
    answer: byId('answer'),
    btnHint: byId('btnHint'),
    btnSubmit: byId('btnSubmit'),
    btnNext: byId('btnNext'),
    hint: byId('hint'),
    status: byId('status'),
    finalTitle: byId('finalTitle'),
    finalBody: byId('finalBody'),
    btnHome: byId('btnHome'),
    sC: byId('sCorrect'),
    sW: byId('sWrong'),
  };

  // 상태
  const S = {
    mode: null,      // 'practice' | 'test'
    pool: [],        // 문제들(랜덤 25)
    idx: 0,
    correct: 0
  };

  // 초기 볼륨
  el.sC.volume = VOL_CORRECT;
  el.sW.volume = VOL_WRONG;

  // 유틸
  function byId(id){ return document.getElementById(id); }
  function show(node){ node.classList.remove('hide'); }
  function hide(node){ node.classList.add('hide'); }

  function shuffle(a){
    for (let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  // 문자열 정규화 (공백·대소문자)
  const stripSpaces = s => (s||'').replace(/\s+/g,'');
  const norm = s => String(s||'').trim().toLowerCase();

  // 숫자/단어 키 포함 검사 (8075 방지)
  function containsKey(user, key, ignoreSpaces){
    const rawKey = String(key);
    const u = ignoreSpaces ? norm(stripSpaces(user)) : norm(user);
    const k = ignoreSpaces ? norm(stripSpaces(rawKey)) : norm(rawKey);

    // 숫자만인 키 → 단어경계로 정확히 포함(8075 방지)
    if (/^\d+$/.test(k)){
      const target = ignoreSpaces ? stripSpaces(user) : user;
      const regex = new RegExp(`(^|\\D)${k}(?=\\D|$)`);
      return regex.test(target);
    }
    // 그 외(한글/문자) → 포함
    return u.includes(k);
  }

  // 정답 판정
  function isCorrect(q){
    if (q.type === 'mc'){
      const checked = document.querySelector('input[name=choice]:checked');
      if (!checked) return null;
      return Number(checked.value) === Number(q.answerIndex);
    }else{
      const user = el.answer.value || '';
      const hasContains = q.mode === 'contains' && q.contains;
      if (hasContains){
        const all = Array.isArray(q.contains.all) ? q.contains.all : [];
        const any = Array.isArray(q.contains.any) ? q.contains.any : [];
        if (all.length){
          for (const k of all){
            if (!containsKey(user, k, !!q.ignoreSpaces)) return false;
          }
          return true;
        }
        if (any.length){
          for (const k of any){
            if (containsKey(user, k, !!q.ignoreSpaces)) return true;
          }
          return false;
        }
      }
      // 기본: answers 중 하나와(공백무시 옵션 지원) 일치
      if (Array.isArray(q.answers)){
        const t = q.ignoreSpaces ? norm(stripSpaces(user)) : norm(user);
        return q.answers.some(a=>{
          const key = q.ignoreSpaces ? norm(stripSpaces(String(a))) : norm(String(a));
          return t === key;
        });
      }
      return false;
    }
  }

  // 사운드
  const playC=()=>{ try{ el.sC.currentTime=0; el.sC.play(); }catch{} };
  const playW=()=>{ try{ el.sW.currentTime=0; el.sW.play(); }catch{} };

  // 문제 표시
  function render(){
    const q = S.pool[S.idx];
    el.progress.textContent = `${S.mode==='practice'?'연습':'실전'}모드  ·  문제 ${S.idx+1} / ${S.pool.length}`;
    el.question.textContent = q.q;
    el.status.textContent = '';
    hide(el.hint); el.hint.textContent = '';

    // 보기/입력 초기화
    el.choices.innerHTML = '';
    el.answer.value = '';

    if (q.type === 'mc'){
      show(el.choices); hide(el.answer);
      q.choices.forEach((c,i)=>{
        const lab = document.createElement('label');
        lab.innerHTML = `<input type="radio" name="choice" value="${i}"> ${c}`;
        el.choices.appendChild(lab);
      });
      hide(el.btnHint);
    }else{
      hide(el.choices); show(el.answer);
      // 힌트: 연습모드 + 힌트가 있을 때만 버튼 노출
      if (S.mode==='practice' && q.hint && q.hint!=='힌트 없음'){
        show(el.btnHint);
      }else{
        hide(el.btnHint);
      }
    }

    el.btnHint.onclick = ()=>{
      if (q.hint && q.hint!=='힌트 없음'){
        el.hint.innerHTML = `<span style="color:#6b7280">힌트</span> : ${q.hint}`;
        show(el.hint);
      }
    };

    el.btnSubmit.disabled = false;
    hide(el.btnNext);
  }

  // 다음 문제
  function goNext(){
    S.idx++;
    if (S.idx >= S.pool.length){
      // 종료
      hide(el.qCard); show(el.fCard);
      el.finalTitle.textContent = '수고했습니다♥';
      el.finalBody.innerHTML =
        `총 ${S.pool.length}문제 중 <b>${S.correct}</b>개 정답 · 점수 <b>${Math.round((S.correct/S.pool.length)*100)}</b>점`;
    }else{
      render();
    }
  }

  // 시작
  async function start(mode){
    // 로드
    const res = await fetch('questions_tuned_70.json?v=' + Date.now());
    const data = await res.json();

    // 랜덤 25문제
    const pool = shuffle(data.slice());
    S.pool = pool.slice(0, PICK_COUNT);

    // 상태 초기화
    S.mode = mode;
    S.idx = 0;
    S.correct = 0;

    // 화면
    hide(el.fCard); show(el.qCard);
    render();
  }

  // 제출
  el.btnSubmit.onclick = ()=>{
    const q = S.pool[S.idx];
    const res = isCorrect(q);

    if (res === null){
      el.status.innerHTML = '<span class="bad">먼저 답을 선택/입력해 주세요.</span>';
      return;
    }

    if (res){
      S.correct++;
      playC();
      el.status.innerHTML = '<span class="ok">딩동댕! 정답입니다.</span>';
      el.btnSubmit.disabled = true;
      hide(el.btnNext);                    // 정답이면 다음버튼 숨김
      setTimeout(goNext, 850);             // 연습/실전 모두 자동 이동
    }else{
      playW();
      el.status.innerHTML = '<span class="bad">땡! 다시 시도해 보자.</span>';
      if (S.mode === 'practice'){
        show(el.btnNext);                  // 연습: 오답이면 다음버튼 표시(재도전 가능)
      }else{
        setTimeout(goNext, 850);           // 실전: 오답도 자동 이동
      }
    }
  };

  el.btnNext.onclick = goNext;
  el.btnPractice.onclick = ()=> start('practice');
  el.btnTest.onclick = ()=> start('test');
  el.btnHome.onclick = ()=>{
    hide(el.qCard); hide(el.fCard);
    window.scrollTo({top:0,behavior:'smooth'});
  };
  </script>
</body>
</html>
