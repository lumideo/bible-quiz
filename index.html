<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>초등2부 성경퀴즈</title>
  <link rel="preload" href="questions_tuned_70.json" as="fetch" crossorigin="anonymous">
  <style>
    :root {
      --bg:#f7f7fb; --card:#fff; --txt:#222; --muted:#666; --brand:#4f46e5; --ok:#16a34a; --bad:#dc2626;
      --btn:#4f46e5; --btn-txt:#fff; --btn-sec:#eef2ff; --btn-sec-txt:#3730a3;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .hero{background:linear-gradient(180deg,#eef2ff,#fff);border-radius:16px;padding:24px 20px;margin-bottom:16px;border:1px solid #e5e7eb}
    h1{margin:0 0 8px;font-size:28px}
    .sub{margin:0;color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--btn);color:var(--btn-txt)}
    .btn-secondary{background:var(--btn-sec);color:var(--btn-sec-txt)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:18px}
    .q-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .badge{font-size:12px;color:#555;background:#eef2ff;border-radius:999px;padding:6px 10px}
    .q-text{font-size:18px;line-height:1.5;margin:10px 0 12px}
    .choices{display:grid;gap:10px;margin-top:6px}
    .choice{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;cursor:pointer}
    .choice input{margin-right:8px}
    .answer-box input{width:100%;font-size:16px;padding:12px;border-radius:10px;border:1px solid #d1d5db}
    .hint-bar{display:flex;align-items:center;gap:8px;margin-top:10px}
    .hint-box{display:none;background:#fffbeb;border:1px solid #fde68a;color:#92400e;border-radius:10px;padding:10px;margin-top:6px}
    .footer-bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{color:var(--muted);font-size:14px;margin-top:6px}
    .score{font-weight:700}
    .hidden{display:none!important}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:var(--brand);width:0%}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>초등2부 성경퀴즈</h1>
      <p class="sub">얘들아 문제를 풀어 볼까요?</p>
      <div class="row">
        <button id="btnPractice" class="btn btn-primary">연습문제</button>
        <button id="btnExam" class="btn btn-secondary">실전문제</button>
      </div>
    </div>

    <div id="screen" class="card hidden">
      <div class="q-head">
        <div>
          <span id="modeBadge" class="badge">모드</span>
        </div>
        <div style="min-width:180px;width:40%;max-width:320px">
          <div class="progress"><div id="prog"></div></div>
        </div>
      </div>

      <div id="qNum" class="status">문제 1 / 25</div>
      <div id="qText" class="q-text"></div>

      <div id="choices" class="choices"></div>

      <div id="fillWrap" class="answer-box hidden">
        <input id="fillInput" type="text" placeholder="정답을 입력하세요" autocomplete="off">
      </div>

      <div class="hint-bar">
        <button id="hintBtn" class="btn btn-secondary" style="display:none">힌트 보기</button>
        <div id="hintBox" class="hint-box"><span id="hintText"></span></div>
      </div>

      <div class="footer-bar">
        <button id="submitBtn" class="btn btn-primary">제출하기</button>
        <button id="nextBtn" class="btn btn-secondary hidden">다음 문제</button>
      </div>

      <div id="status" class="status"></div>
    </div>

    <div id="result" class="card hidden">
      <h2>결과</h2>
      <p class="q-text">수고했습니다♥</p>
      <p class="status">맞춘 개수: <span id="rightCount" class="score"></span> / <span id="totalCount"></span></p>
      <p class="status">점수: <span id="percent" class="score"></span> 점</p>
      <div class="row">
        <button id="retryPractice" class="btn btn-secondary">연습 다시하기</button>
        <button id="retryExam" class="btn btn-primary">실전 다시하기</button>
      </div>
    </div>
  </div>

  <!-- 사운드 -->
  <audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
  <audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

  <script>
  // ===== 전역 상태 =====
  const S = {
    all: [],
    pool: [],
    idx: 0,
    mode: 'practice', // 'practice' | 'exam'
    answered: false,
    correctCount: 0,
    total: 25,
  };

  const el = {
    btnPractice: document.getElementById('btnPractice'),
    btnExam: document.getElementById('btnExam'),
    screen: document.getElementById('screen'),
    result: document.getElementById('result'),
    modeBadge: document.getElementById('modeBadge'),
    qNum: document.getElementById('qNum'),
    qText: document.getElementById('qText'),
    choices: document.getElementById('choices'),
    fillWrap: document.getElementById('fillWrap'),
    fillInput: document.getElementById('fillInput'),
    hintBtn: document.getElementById('hintBtn'),
    hintBox: document.getElementById('hintBox'),
    hintText: document.getElementById('hintText'),
    submitBtn: document.getElementById('submitBtn'),
    nextBtn: document.getElementById('nextBtn'),
    status: document.getElementById('status'),
    prog: document.getElementById('prog'),
    resultRight: document.getElementById('rightCount'),
    resultTotal: document.getElementById('totalCount'),
    resultPercent: document.getElementById('percent'),
    retryPractice: document.getElementById('retryPractice'),
    retryExam: document.getElementById('retryExam'),
    audioCorrect: document.getElementById('audio-correct'),
    audioWrong: document.getElementById('audio-wrong'),
  };

  // ===== 사운드 (볼륨/재생) =====
  function playCorrect() {
    try {
      el.audioCorrect.volume = 0.95; // 딩동댕 조금 크게
      el.audioCorrect.currentTime = 0;
      el.audioCorrect.play();
    } catch(e){}
  }
  function playWrong() {
    try {
      el.audioWrong.volume = 0.95;
      el.audioWrong.currentTime = 0;
      el.audioWrong.play();
    } catch(e){}
  }

  // ===== 유틸 =====
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
  function sample25(arr){return shuffle(arr.slice()).slice(0,25)}
  function stripSpaces(s){return s.replace(/\s+/g,'')}
  function norm(s){return s.normalize('NFC').trim().toLowerCase()}

  // contains 검사
  function checkContains(userText, q){
    const raw = q.ignoreSpaces ? stripSpaces(userText) : userText;
    const t = norm(raw);

    const c = q.contains || {};
    const hasAll = Array.isArray(c.all) && c.all.length>0;
    const keysAll = hasAll ? c.all : [];
    const keysAny = Array.isArray(c.any) ? c.any : [];

    if (hasAll){
      // 모두 포함
      for (const k of keysAll){
        const key = norm(q.ignoreSpaces ? stripSpaces(String(k)) : String(k));
        if (!t.includes(key)) return false;
      }
      return true;
    }
    if (keysAny.length){
      // 아무거나 하나 포함
      for (const k of keysAny){
        const key = norm(q.ignoreSpaces ? stripSpaces(String(k)) : String(k));
        if (t.includes(key)) return true;
      }
      return false;
    }
    // contains 정의가 없으면 정확매칭 대비: answers 있으면 answers 사용
    if (Array.isArray(q.answers)){
      for (const ans of q.answers){
        const key = norm(q.ignoreSpaces ? stripSpaces(String(ans)) : String(ans));
        if (t === key) return true;
      }
      return false;
    }
    return false;
  }

  // 정답 판정
  function isCorrect(q){
    if (q.type === 'mc'){
      const picked = document.querySelector('input[name="choice"]:checked');
      if (!picked) return null; // 무응답
      const idx = Number(picked.value);
      return idx === q.answerIndex;
    } else {
      const val = el.fillInput.value || '';
      if (!val.trim()) return null; // 무응답
      if (q.mode === 'contains') return checkContains(val, q);
      // fallback: answers 배열 정확매칭
      if (Array.isArray(q.answers)){
        const t = norm(q.ignoreSpaces ? stripSpaces(val) : val);
        return q.answers.some(a=>{
          const key = norm(q.ignoreSpaces ? stripSpaces(String(a)) : String(a));
          return t === key;
        });
      }
      return false;
    }
  }

  // ===== 부드러운 자동 힌트 생성기 (B버전) =====
  function buildHintText(q, isPractice) {
    // 1) JSON hint가 있으면 우선 사용 (단, "힌트 없음"은 무시)
    if (q.hint && q.hint.trim() && q.hint !== "힌트 없음") return q.hint;

    // 2) 연습모드 + 주관식 contains면 자동 힌트
    if (isPractice && q.type === "fill" && q.mode === "contains") {
      const keys = (q.contains?.all && q.contains.all.length)
        ? q.contains.all
        : (q.contains?.any || []);
      if (keys.length) return "힌트: " + keys.join(", ");
    }

    // 3) 그 외엔 힌트 없음
    return "힌트 없음";
  }

  // ===== 문제 렌더 =====
  function render(){
    const q = S.pool[S.idx];
    const isPractice = S.mode === 'practice';

    el.modeBadge.textContent = (S.mode === 'practice') ? '연습모드' : '실전모드';
    el.qNum.textContent = `문제 ${S.idx+1} / ${S.total}`;
    el.qText.textContent = q.q;

    // 프로그레스
    el.prog.style.width = `${Math.round((S.idx)/S.total*100)}%`;

    // 초기화
    el.choices.innerHTML = '';
    el.fillWrap.classList.add('hidden');
    el.hintBox.style.display = 'none';
    el.hintText.textContent = '';
    el.hintBtn.style.display = 'none';
    el.fillInput.value = '';
    el.status.textContent = '';
    el.nextBtn.classList.add('hidden');
    el.submitBtn.disabled = false;

    if (q.type === 'mc'){
      // 보기 만들기
      q.choices.forEach((c,i)=>{
        const id = `ch_${i}`;
        const label = document.createElement('label');
        label.className = 'choice';
        label.innerHTML = `<input type="radio" name="choice" value="${i}" id="${id}"> ${c}`;
        el.choices.appendChild(label);
      });
    } else {
      // 주관식
      el.fillWrap.classList.remove('hidden');
    }

    // 힌트 버튼 노출 규칙
    const built = buildHintText(q, isPractice);
    const hasHint = built && built !== "힌트 없음";
    // 버튼은: (JSON 힌트가 있거나) 또는 (연습모드+주관식 contains)면 표시
    if (hasHint || (isPractice && q.type==='fill' && q.mode==='contains')) {
      el.hintBtn.style.display = 'inline-flex';
    } else {
      el.hintBtn.style.display = 'none';
    }

    // 힌트 클릭
    el.hintBtn.onclick = () => {
      const txt = buildHintText(q, isPractice);
      const show = txt && txt !== "힌트 없음";
      el.hintText.textContent = show ? txt : '';
      el.hintBox.style.display = show ? 'block' : 'none';
    };

    // 제출
    el.submitBtn.onclick = () => {
      const res = isCorrect(q);
      if (res === null){
        // 무응답 방지(실전/연습 동일하게 안내)
        el.status.innerHTML = '<span class="bad">먼저 답을 선택하거나 입력해 주세요.</span>';
        return;
      }
      if (res){
        playCorrect();
        el.status.innerHTML = '<span class="ok">딩동댕! 정답입니다.</span>';
        S.correctCount++;
        if (isPractice){
          // 연습: 맞추면 자동 다음
          goNextAuto();
        } else {
          // 실전: 채점 후 자동 다음
          goNextAuto();
        }
      } else {
        playWrong();
        el.status.innerHTML = '<span class="bad">땡! 다시 도전해 보자.</span>';
        if (isPractice){
          // 연습: 틀리면 머물기
        } else {
          // 실전: 자동 다음
          goNextAuto();
        }
      }
    };

    // 다음 버튼(연습에서만 수동으로 쓰일 수 있음)
    el.nextBtn.onclick = () => goNext();
  }

  function goNextAuto(){
    // 900ms 후 다음 문제
    el.submitBtn.disabled = true;
    setTimeout(goNext, 900);
  }

  function goNext(){
    S.idx++;
    el.prog.style.width = `${Math.round((S.idx)/S.total*100)}%`;
    if (S.idx >= S.total){
      finish();
      return;
    }
    render();
  }

  function finish(){
    el.screen.classList.add('hidden');
    el.result.classList.remove('hidden');
    el.resultTotal.textContent = S.total;
    el.resultRight.textContent = S.correctCount;
    const percent = Math.round((S.correctCount / S.total) * 100);
    el.resultPercent.textContent = percent;
  }

  // ===== 시작/재도전 =====
  function start(mode){
    S.mode = mode;
    S.idx = 0;
    S.correctCount = 0;
    S.pool = sample25(S.all);
    el.screen.classList.remove('hidden');
    el.result.classList.add('hidden');
    render();
  }

  el.btnPractice.addEventListener('click', ()=>start('practice'));
  el.btnExam.addEventListener('click', ()=>start('exam'));
  el.retryPractice.addEventListener('click', ()=>start('practice'));
  el.retryExam.addEventListener('click', ()=>start('exam'));

  // ===== 데이터 로드 =====
  async function init(){
    try{
      const res = await fetch('questions_tuned_70.json?v=' + Date.now());
      const data = await res.json();
      // 방어: 배열 병합 형태 들어올 수도 있어 한 번 평탄화
      S.all = Array.isArray(data) ? data.flat() : [];
    } catch(e){
      alert('문제 데이터를 불러오지 못했습니다.');
      console.error(e);
      return;
    }
  }

  init();
  </script>
</body>
</html>
