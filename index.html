<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì´ˆë“±2ë¶€ ì„±ê²½í€´ì¦ˆ</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --brand:#4f46e5; --ok:#16a34a; --bad:#ef4444;
    --bg:#ffffff; --text:#111827; --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:18px 14px}
  header{background:#fff;border-bottom:1px solid #e5e7eb;border-radius:0;padding:16px 0 10px;margin:0 0 10px;text-align:center}
  h1{margin:0 0 6px;font-size:28px}
  .sub{margin:0;color:var(--muted);font-size:14px}
  .modes{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .btn{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);color:#fff}
  .btn.ghost{background:#f3f4f6;color:#111}
  .btn.gray{background:#f3f4f6}
  .hide{display:none!important}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:none;padding:16px}
  .progress{color:var(--muted);font-size:14px;margin-bottom:6px}
  .q{font-size:20px;line-height:1.55;white-space:pre-wrap;margin:8px 0 10px}
  .choices label{display:block;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;margin:8px 0;cursor:pointer}
  .choices input{margin-right:8px}
  .input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .status{min-height:22px;margin-top:6px;font-weight:700}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .center{text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header id="hero">
    <h1>ì´ˆë“±2ë¶€ ì„±ê²½í€´ì¦ˆ</h1>
    <p class="sub">ì–˜ë“¤ì•„ ë¬¸ì œë¥¼ í’€ì–´ ë³¼ê¹Œìš”?</p>
    <div class="modes">
      <button id="btnPractice" class="btn primary">ì—°ìŠµë¬¸ì œ</button>
      <button id="btnTest" class="btn ghost">ì‹¤ì „ë¬¸ì œ</button>
    </div>
  </header>

  <!-- ë¬¸ì œ ì¹´ë“œ: ì‹œì‘ ì „ì—” ìˆ¨ê¹€ -->
  <div id="quiz" class="card hide">
    <div class="progress" id="modeLabel">ì—°ìŠµëª¨ë“œ Â· ë¬¸ì œ <span id="qnum">1</span> / <span id="qtotal">25</span></div>
    <div class="q" id="question">ë¬¸ì œê°€ ë¡œë“œë©ë‹ˆë‹¤â€¦</div>

    <div id="mcArea" class="choices hide"></div>

    <div id="fillArea" class="hide">
      <input id="answerInput" class="input" type="text" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" />
      <div class="actions">
        <button id="btnHint" class="btn gray">íŒíŠ¸ ë³´ê¸°</button>
      </div>
      <div id="hintText" class="sub" style="margin-top:6px"></div>
    </div>

    <div class="actions">
      <button id="btnSubmit" class="btn primary">ì œì¶œí•˜ê¸°</button>
    </div>
    <div id="status" class="status"></div>
  </div>

  <!-- ì™„ë£Œ ì¹´ë“œ -->
  <div id="resultCard" class="card hide center">
    <div id="resultTitle" style="font-size:22px; font-weight:800; margin-bottom:6px;">ìˆ˜ê³ í–ˆìŠµë‹ˆë‹¤ â™¥</div>
    <div id="resultBody" class="sub"></div>
    <div class="modes" style="justify-content:center; margin-top:12px;">
      <button id="btnRestartP" class="btn primary">ì—°ìŠµ ë‹¤ì‹œí•˜ê¸°</button>
      <button id="btnRestartT" class="btn ghost">ì‹¤ì „ ë‹¤ì‹œí•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- ì‚¬ìš´ë“œ -->
<audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
<audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

<script>
/* ------------------ ìœ í‹¸ ------------------ */
const CORRECT_VOL = 0.95; // ë”©ë™ëŒ•
const WRONG_VOL   = 1.0;  // ë•¡

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function stripSpaces(s){ return String(s).replace(/\s+/g,''); }
function norm(s){
  return String(s).toLowerCase()
    .replace(/\u00A0/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function isNumericString(s){ return /^[0-9]+$/.test(String(s)); }

// â€œë¶™ì—¬ì“°ê¸° í†µê³¼â€ ë°©ì§€ìš© í¬í•¨ê²€ì‚¬(ìˆ«ìëŠ” ê²½ê³„ í•„ìš”)
function includesWithBoundary(hay, needle){
  if (!needle) return false;
  if (isNumericString(needle)){
    // ì•ë’¤ê°€ ìˆ«ìê°€ ì•„ë‹Œ ê²½ìš°ë§Œ í—ˆìš©
    const re = new RegExp(`(?<!\\d)${needle}(?!\\d)`);
    return re.test(hay);
  }
  return hay.includes(needle);
}

/* ------------------ ìƒíƒœ ------------------ */
let ALL = [];                 // ì „ì²´ 70ë¬¸ì œ ë¡œë“œ
let deck = [];                // ì´ë²ˆì— í’€ 25ë¬¸ì œ
let idx = 0;                  // í˜„ì¬ ì¸ë±ìŠ¤
let mode = 'practice';        // 'practice' | 'test'
let correctCount = 0;

/* ------------------ ë¡œë“œ ------------------ */
fetch('questions_tuned_70.json?v=' + Date.now())
  .then(r => r.json())
  .then(data => { ALL = data; initUI(); })
  .catch(e => {
    console.error(e);
    alert('ë¬¸ì œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.');
  });

function initUI(){
  $('#btnPractice').onclick = () => start('practice');
  $('#btnTest').onclick     = () => start('test');

  $('#btnSubmit').onclick   = onSubmit;
  $('#btnHint').onclick     = showHint;

  $('#btnRestartP').onclick = () => start('practice');
  $('#btnRestartT').onclick = () => start('test');

  // ì‚¬ìš´ë“œ ë³¼ë¥¨
  $('#audio-correct').volume = CORRECT_VOL;
  $('#audio-wrong').volume   = WRONG_VOL;
}

/* ------------------ ì‹œì‘/ë± êµ¬ì„± ------------------ */
function start(m){
  mode = m;
  correctCount = 0;
  idx = 0;

  // 70ê°œ ì¤‘ 25ê°œ ëœë¤
  deck = shuffle([...ALL]).slice(0,25);

  // UI ìƒíƒœ
  $('#hero').classList.add('hide');     // ë¬¸ì œë§Œ ë³´ì´ê²Œ
  $('#resultCard').classList.add('hide');
  $('#quiz').classList.remove('hide');

  render();
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ------------------ ë Œë”ë§ ------------------ */
function render(){
  const q = deck[idx];
  $('#qnum').textContent   = (idx+1);
  $('#qtotal').textContent = deck.length;
  $('#modeLabel').textContent = (mode==='practice'?'ì—°ìŠµëª¨ë“œ':'ì‹¤ì „ëª¨ë“œ') + ' Â· ë¬¸ì œ ' + (idx+1) + ' / ' + deck.length;
  $('#question').textContent = q.q;
  $('#status').textContent = '';

  // ì˜ì—­ ì´ˆê¸°í™”
  $('#mcArea').classList.add('hide');
  $('#fillArea').classList.add('hide');
  $('#hintText').textContent = '';

  if (q.type === 'mc'){
    const area = $('#mcArea');
    area.innerHTML = '';
    q.choices.forEach((c,i)=>{
      const id = 'c_' + i;
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="radio" name="choice" value="${i}" id="${id}"> ${c}`;
      area.appendChild(lab);
    });
    area.classList.remove('hide');
    $('#btnHint').classList.add('hide'); // ê°ê´€ì‹ì€ íŒíŠ¸ ë²„íŠ¼ ìˆ¨ê¹€
  } else {
    // ì£¼ê´€ì‹
    const inp = $('#answerInput');
    inp.value = '';
    $('#fillArea').classList.remove('hide');

    // ì—°ìŠµëª¨ë“œ & hintê°€ ìˆì„ ë•Œë§Œ ë²„íŠ¼ ë…¸ì¶œ
    if (mode==='practice' && q.hint && String(q.hint).trim()){
      $('#btnHint').classList.remove('hide');
    } else {
      $('#btnHint').classList.add('hide');
    }
  }
}

/* ------------------ ì±„ì  ------------------ */
function onSubmit(){
  const q = deck[idx];

  if (q.type === 'mc'){
    const sel = document.querySelector('input[name="choice"]:checked');
    if (!sel){
      // ì‹¤ì „/ì—°ìŠµ ê³µí†µ: ë¯¸ì„ íƒ ì‹œ ì§„í–‰ ê¸ˆì§€
      $('#status').textContent = 'ë¨¼ì € ë³´ê¸°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.';
      $('#status').className = 'status bad';
      return;
    }
    const ok = Number(sel.value) === Number(q.answerIndex);
    afterJudge(ok);
    return;
  }

  // ì£¼ê´€ì‹
  const userRaw = $('#answerInput').value || '';
  if (!userRaw.trim()){
    $('#status').textContent = 'ì •ë‹µì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
    $('#status').className = 'status bad';
    return;
  }

  const ok = checkFill(userRaw, q);
  afterJudge(ok);
}

function afterJudge(ok){
  if (ok){
    $('#audio-correct').currentTime = 0;
    $('#audio-correct').play().catch(()=>{});
    $('#status').textContent = mode==='practice' ? 'ë”©ë™ëŒ•! ì˜í–ˆì–´ìš” ğŸ‘' : 'ì •ë‹µ!';
    $('#status').className = 'status ok';
    correctCount++;

    if (mode==='practice'){
      // ì—°ìŠµ: ë§ì•„ì•¼ ë‹¤ìŒìœ¼ë¡œ, ë§ìœ¼ë©´ ìë™ ì§„í–‰
      setTimeout(next, 700);
    } else {
      // ì‹¤ì „: ìë™ ì§„í–‰
      setTimeout(next, 600);
    }
  } else {
    $('#audio-wrong').currentTime = 0;
    $('#audio-wrong').play().catch(()=>{});
    $('#status').textContent = mode==='practice' ? 'ë•¡! ë‹¤ì‹œ ì‹œë„í•´ë´ìš”' : 'ì˜¤ë‹µ';
    $('#status').className = 'status bad';

    if (mode==='test'){
      // ì‹¤ì „ì€ ì˜¤ë‹µì´ì–´ë„ ìë™ ì§„í–‰
      setTimeout(next, 700);
    }
    // ì—°ìŠµì€ ì˜¤ë‹µì´ë©´ ë¨¸ë¬´ë¦„(ë§ì•„ì•¼ ë‹¤ìŒìœ¼ë¡œ)
  }
}

function next(){
  idx++;
  if (idx >= deck.length){
    finish();
  } else {
    render();
  }
}

function finish(){
  $('#quiz').classList.add('hide');
  $('#resultCard').classList.remove('hide');

  if (mode==='practice'){
    $('#resultTitle').textContent = 'ìˆ˜ê³ í–ˆìŠµë‹ˆë‹¤ â™¥';
    $('#resultBody').textContent  = 'ì—°ìŠµëª¨ë“œ ì¢…ë£Œ';
  } else {
    const score = Math.round((correctCount / deck.length) * 100);
    $('#resultTitle').textContent = 'ì‹¤ì „ ì ìˆ˜';
    $('#resultBody').textContent  = `ì •ë‹µ ${correctCount} / ${deck.length} ( ${score} ì  )`;
  }
}

/* ------------------ ì£¼ê´€ì‹ ì±„ì  ë¡œì§ ------------------ */
function checkFill(userText, q){
  // ì „ì²˜ë¦¬
  const raw = q.ignoreSpaces ? stripSpaces(userText) : userText;
  const t = norm(raw);

  // contains ìš°ì„ 
  if (q.mode === 'contains' || q.contains){
    const c = q.contains || {};
    const hasAll = Array.isArray(c.all) && c.all.length>0;
    const keysAll = hasAll ? c.all : [];
    const keysAny = Array.isArray(c.any) ? c.any : [];

    const prep = (s)=> norm(q.ignoreSpaces ? stripSpaces(String(s)) : String(s));

    if (hasAll){
      for (const k of keysAll){
        const key = prep(k);
        if (!includesWithBoundary(t, key)) return false;
      }
      return true;
    }
    if (keysAny.length){
      for (const k of keysAny){
        const key = prep(k);
        if (includesWithBoundary(t, key)) return true;
      }
      return false;
    }
    // contains ì§€ì •ì´ ìˆëŠ”ë° ë°°ì—´ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
    return false;
  }

  // answers(ì •í™• ì¼ì¹˜) ì§€ì›
  if (Array.isArray(q.answers)){
    for (const ans of q.answers){
      const key = norm(q.ignoreSpaces ? stripSpaces(String(ans)) : String(ans));
      if (t === key) return true;
    }
    return false;
  }
  return false;
}

/* ------------------ íŒíŠ¸ ------------------ */
function showHint(){
  const q = deck[idx];
  if (q.type !== 'fill') return;

  const hasHint = q.hint && String(q.hint).trim().length>0;
  if (hasHint){
    $('#hintText').textContent = q.hint;
  } else {
    // í˜„ì¬ ì •ì±…: íŒíŠ¸ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ìì²´ê°€ ì•ˆ ë³´ì´ë¯€ë¡œ ë³´í†µ ë„ë‹¬í•˜ì§€ ì•ŠìŒ
    $('#hintText').textContent = 'íŒíŠ¸ ì—†ìŒ';
  }
}
</script>
</body>
</html>
