<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>초등2부 성경퀴즈</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --brand:#4f46e5; --ok:#16a34a; --bad:#ef4444;
    --bg:#ffffff; --text:#111827; --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:18px 14px}
  header{background:#fff;border-bottom:1px solid #e5e7eb;border-radius:0;padding:16px 0 10px;margin:0 0 10px;text-align:center}
  h1{margin:0 0 6px;font-size:28px}
  .sub{margin:0;color:var(--muted);font-size:14px}
  .modes{display:flex;gap:10px;justify-content:center;margin-top:10px}
  .btn{padding:10px 14px;border:0;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);color:#fff}
  .btn.ghost{background:#f3f4f6;color:#111}
  .btn.gray{background:#f3f4f6}
  .hide{display:none!important}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:none;padding:16px}
  .progress{color:var(--muted);font-size:14px;margin-bottom:6px}
  .q{font-size:20px;line-height:1.55;white-space:pre-wrap;margin:8px 0 10px}
  .choices label{display:block;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;margin:8px 0;cursor:pointer}
  .choices input{margin-right:8px}
  .input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .status{min-height:22px;margin-top:6px;font-weight:700}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .center{text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <header id="hero">
    <h1>초등2부 성경퀴즈</h1>
    <p class="sub">얘들아 문제를 풀어 볼까요?</p>
    <div class="modes">
      <button id="btnPractice" class="btn primary">연습문제</button>
      <button id="btnTest" class="btn ghost">실전문제</button>
    </div>
  </header>

  <!-- 문제 카드: 시작 전엔 숨김 -->
  <div id="quiz" class="card hide">
    <div class="progress" id="modeLabel">연습모드 · 문제 <span id="qnum">1</span> / <span id="qtotal">25</span></div>
    <div class="q" id="question">문제가 로드됩니다…</div>

    <div id="mcArea" class="choices hide"></div>

    <div id="fillArea" class="hide">
      <input id="answerInput" class="input" type="text" placeholder="정답을 입력하세요" autocomplete="off" />
      <div class="actions">
        <button id="btnHint" class="btn gray">힌트 보기</button>
      </div>
      <div id="hintText" class="sub" style="margin-top:6px"></div>
    </div>

    <div class="actions">
      <button id="btnSubmit" class="btn primary">제출하기</button>
    </div>
    <div id="status" class="status"></div>
  </div>

  <!-- 완료 카드 -->
  <div id="resultCard" class="card hide center">
    <div id="resultTitle" style="font-size:22px; font-weight:800; margin-bottom:6px;">수고했습니다 ♥</div>
    <div id="resultBody" class="sub"></div>
    <div class="modes" style="justify-content:center; margin-top:12px;">
      <button id="btnRestartP" class="btn primary">연습 다시하기</button>
      <button id="btnRestartT" class="btn ghost">실전 다시하기</button>
    </div>
  </div>
</div>

<!-- 사운드 -->
<audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
<audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

<script>
/* ------------------ 유틸 ------------------ */
const CORRECT_VOL = 0.95; // 딩동댕
const WRONG_VOL   = 1.0;  // 땡

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

function stripSpaces(s){ return String(s).replace(/\s+/g,''); }
function norm(s){
  return String(s).toLowerCase()
    .replace(/\u00A0/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function isNumericString(s){ return /^[0-9]+$/.test(String(s)); }

// “붙여쓰기 통과” 방지용 포함검사(숫자는 경계 필요)
function includesWithBoundary(hay, needle){
  if (!needle) return false;
  if (isNumericString(needle)){
    // 앞뒤가 숫자가 아닌 경우만 허용
    const re = new RegExp(`(?<!\\d)${needle}(?!\\d)`);
    return re.test(hay);
  }
  return hay.includes(needle);
}

/* ------------------ 상태 ------------------ */
let ALL = [];                 // 전체 70문제 로드
let deck = [];                // 이번에 풀 25문제
let idx = 0;                  // 현재 인덱스
let mode = 'practice';        // 'practice' | 'test'
let correctCount = 0;

/* ------------------ 로드 ------------------ */
fetch('questions_tuned_70.json?v=' + Date.now())
  .then(r => r.json())
  .then(data => { ALL = data; initUI(); })
  .catch(e => {
    console.error(e);
    alert('문제 파일을 불러오지 못했어요.');
  });

function initUI(){
  $('#btnPractice').onclick = () => start('practice');
  $('#btnTest').onclick     = () => start('test');

  $('#btnSubmit').onclick   = onSubmit;
  $('#btnHint').onclick     = showHint;

  $('#btnRestartP').onclick = () => start('practice');
  $('#btnRestartT').onclick = () => start('test');

  // 사운드 볼륨
  $('#audio-correct').volume = CORRECT_VOL;
  $('#audio-wrong').volume   = WRONG_VOL;
}

/* ------------------ 시작/덱 구성 ------------------ */
function start(m){
  mode = m;
  correctCount = 0;
  idx = 0;

  // 70개 중 25개 랜덤
  deck = shuffle([...ALL]).slice(0,25);

  // UI 상태
  $('#hero').classList.add('hide');     // 문제만 보이게
  $('#resultCard').classList.add('hide');
  $('#quiz').classList.remove('hide');

  render();
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ------------------ 렌더링 ------------------ */
function render(){
  const q = deck[idx];
  $('#qnum').textContent   = (idx+1);
  $('#qtotal').textContent = deck.length;
  $('#modeLabel').textContent = (mode==='practice'?'연습모드':'실전모드') + ' · 문제 ' + (idx+1) + ' / ' + deck.length;
  $('#question').textContent = q.q;
  $('#status').textContent = '';

  // 영역 초기화
  $('#mcArea').classList.add('hide');
  $('#fillArea').classList.add('hide');
  $('#hintText').textContent = '';

  if (q.type === 'mc'){
    const area = $('#mcArea');
    area.innerHTML = '';
    q.choices.forEach((c,i)=>{
      const id = 'c_' + i;
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="radio" name="choice" value="${i}" id="${id}"> ${c}`;
      area.appendChild(lab);
    });
    area.classList.remove('hide');
    $('#btnHint').classList.add('hide'); // 객관식은 힌트 버튼 숨김
  } else {
    // 주관식
    const inp = $('#answerInput');
    inp.value = '';
    $('#fillArea').classList.remove('hide');

    // 연습모드 & hint가 있을 때만 버튼 노출
    if (mode==='practice' && q.hint && String(q.hint).trim()){
      $('#btnHint').classList.remove('hide');
    } else {
      $('#btnHint').classList.add('hide');
    }
  }
}

/* ------------------ 채점 ------------------ */
function onSubmit(){
  const q = deck[idx];

  if (q.type === 'mc'){
    const sel = document.querySelector('input[name="choice"]:checked');
    if (!sel){
      // 실전/연습 공통: 미선택 시 진행 금지
      $('#status').textContent = '먼저 보기를 선택해 주세요.';
      $('#status').className = 'status bad';
      return;
    }
    const ok = Number(sel.value) === Number(q.answerIndex);
    afterJudge(ok);
    return;
  }

  // 주관식
  const userRaw = $('#answerInput').value || '';
  if (!userRaw.trim()){
    $('#status').textContent = '정답을 입력해 주세요.';
    $('#status').className = 'status bad';
    return;
  }

  const ok = checkFill(userRaw, q);
  afterJudge(ok);
}

function afterJudge(ok){
  if (ok){
    $('#audio-correct').currentTime = 0;
    $('#audio-correct').play().catch(()=>{});
    $('#status').textContent = mode==='practice' ? '딩동댕! 잘했어요 👍' : '정답!';
    $('#status').className = 'status ok';
    correctCount++;

    if (mode==='practice'){
      // 연습: 맞아야 다음으로, 맞으면 자동 진행
      setTimeout(next, 700);
    } else {
      // 실전: 자동 진행
      setTimeout(next, 600);
    }
  } else {
    $('#audio-wrong').currentTime = 0;
    $('#audio-wrong').play().catch(()=>{});
    $('#status').textContent = mode==='practice' ? '땡! 다시 시도해봐요' : '오답';
    $('#status').className = 'status bad';

    if (mode==='test'){
      // 실전은 오답이어도 자동 진행
      setTimeout(next, 700);
    }
    // 연습은 오답이면 머무름(맞아야 다음으로)
  }
}

function next(){
  idx++;
  if (idx >= deck.length){
    finish();
  } else {
    render();
  }
}

function finish(){
  $('#quiz').classList.add('hide');
  $('#resultCard').classList.remove('hide');

  if (mode==='practice'){
    $('#resultTitle').textContent = '수고했습니다 ♥';
    $('#resultBody').textContent  = '연습모드 종료';
  } else {
    const score = Math.round((correctCount / deck.length) * 100);
    $('#resultTitle').textContent = '실전 점수';
    $('#resultBody').textContent  = `정답 ${correctCount} / ${deck.length} ( ${score} 점 )`;
  }
}

/* ------------------ 주관식 채점 로직 ------------------ */
function checkFill(userText, q){
  // 전처리
  const raw = q.ignoreSpaces ? stripSpaces(userText) : userText;
  const t = norm(raw);

  // contains 우선
  if (q.mode === 'contains' || q.contains){
    const c = q.contains || {};
    const hasAll = Array.isArray(c.all) && c.all.length>0;
    const keysAll = hasAll ? c.all : [];
    const keysAny = Array.isArray(c.any) ? c.any : [];

    const prep = (s)=> norm(q.ignoreSpaces ? stripSpaces(String(s)) : String(s));

    if (hasAll){
      for (const k of keysAll){
        const key = prep(k);
        if (!includesWithBoundary(t, key)) return false;
      }
      return true;
    }
    if (keysAny.length){
      for (const k of keysAny){
        const key = prep(k);
        if (includesWithBoundary(t, key)) return true;
      }
      return false;
    }
    // contains 지정이 있는데 배열이 비어 있으면 실패 처리
    return false;
  }

  // answers(정확 일치) 지원
  if (Array.isArray(q.answers)){
    for (const ans of q.answers){
      const key = norm(q.ignoreSpaces ? stripSpaces(String(ans)) : String(ans));
      if (t === key) return true;
    }
    return false;
  }
  return false;
}

/* ------------------ 힌트 ------------------ */
function showHint(){
  const q = deck[idx];
  if (q.type !== 'fill') return;

  const hasHint = q.hint && String(q.hint).trim().length>0;
  if (hasHint){
    $('#hintText').textContent = q.hint;
  } else {
    // 현재 정책: 힌트가 없으면 버튼 자체가 안 보이므로 보통 도달하지 않음
    $('#hintText').textContent = '힌트 없음';
  }
}
</script>
</body>
</html>
