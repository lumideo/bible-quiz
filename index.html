<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>초등2부 성경퀴즈</title>
  <style>
    :root { --bg:#f8fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --brand:#284BA0; --ok:#16a34a; --bad:#dc2626; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .wrap{max-width:840px;margin:40px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:24px;}
    h1{margin:0 0 6px;font-size:28px}
    .sub{color:var(--muted);margin-bottom:24px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#eef2ff;color:#1f2937}
    .btn.small{padding:8px 12px;font-weight:600}
    .muted{color:var(--muted)}
    .qno{font-weight:700;color:var(--brand)}
    .qtext{font-size:20px;margin:10px 0 16px}
    .choices{display:grid;gap:10px}
    .choice{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;cursor:pointer}
    .choice input{margin-right:8px}
    .answerBox{display:flex;gap:10px;margin:8px 0 0}
    input[type="text"]{flex:1;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px}
    .hint{background:#fffbe6;border:1px dashed #f59e0b;color:#92400e;border-radius:10px;padding:10px 12px;margin-top:10px;display:none}
    .status{margin-top:12px;font-weight:700}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:var(--brand);width:0%}
    .footer{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
    .center{text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="screen-home" class="card">
      <h1>초등2부 성경퀴즈</h1>
      <div class="sub">얘들아 문제를 풀어 볼까요?</div>
      <div class="row">
        <button class="btn primary" id="btn-practice">연습문제</button>
        <button class="btn ghost" id="btn-exam">실전문제</button>
      </div>
      <p class="muted" style="margin-top:14px">
        전체 70문제 중 매번 <b>랜덤 25문제</b>가 출제돼요. (재도전할 때마다 새로 섞여요!)
      </p>
    </div>

    <div id="screen-quiz" class="card" style="display:none">
      <div class="topbar">
        <div>
          <div><span id="modeTag" class="muted"></span></div>
          <div><span class="qno" id="qno">1 / 25</span></div>
        </div>
        <button class="btn small ghost" id="btn-exit">처음으로</button>
      </div>
      <div class="progress"><div id="bar"></div></div>

      <div id="qwrap">
        <div class="qtext" id="qtext">문제 텍스트</div>
        <div id="mc-wrap" class="choices"></div>

        <div id="fill-wrap" style="display:none">
          <div class="answerBox">
            <input id="fill-input" type="text" placeholder="정답을 입력해요" autocomplete="off" />
            <button class="btn small ghost" id="btn-hint">힌트</button>
          </div>
          <div id="hint" class="hint"></div>
        </div>

        <div class="footer">
          <button class="btn primary" id="btn-submit">제출하기</button>
          <button class="btn ghost" id="btn-skip" style="display:none">다음 문제</button>
        </div>

        <div id="status" class="status"></div>
      </div>
    </div>

    <div id="screen-finish" class="card center" style="display:none">
      <h1 id="finish-title">수고했습니다♥</h1>
      <p id="finish-desc" class="sub"></p>
      <div class="row" style="justify-content:center">
        <button class="btn primary" id="btn-retry-practice">연습 다시</button>
        <button class="btn ghost" id="btn-retry-exam">실전 다시</button>
        <button class="btn ghost" id="btn-home">처음으로</button>
      </div>
    </div>
  </div>

 <!-- 사운드 -->
<audio id="audio-correct" src="dingdong.mp3" preload="auto"></audio>
<audio id="audio-wrong"   src="ddang.mp3"    preload="auto"></audio>

<script>
  const correctSound = document.getElementById("audio-correct");
  const wrongSound   = document.getElementById("audio-wrong");

  // 볼륨 조절 (0.0 ~ 1.0)
  correctSound.volume = 0.5; // 딩동댕 줄이기
  wrongSound.volume   = 1.2; // 땡 크게
</script>

  <!-- 샘플 한 문제 (실제 사용은 외부 JSON) -->
  <script id="questionsData" type="application/json">[
    { "id": 1, "type": "fill", "q": "창세기 1장 1절: 태초에 하나님이 (      )과 (      )을 창조하시니라", "answers": ["하늘과땅","하늘 땅","하늘과 땅"], "hint": "둘 다 자연 (창세기 1:1)" }
  ]</script>

  <script>
    const FILE_URL="questions_tuned_70.json";
    let ALL=[],PICK=[],MODE=null,idx=0,score=0;
    const TOTAL=25;
    const POINTS_PER_CORRECT=4;

    // refs
    function $(id){return document.querySelector(id);}
    const home=$('#screen-home'),quiz=$('#screen-quiz'),done=$('#screen-finish');
    const qnoEl=$('#qno'),qtextEl=$('#qtext'),mcWrap=$('#mc-wrap'),fillWrap=$('#fill-wrap');
    const fillInput=$('#fill-input'),hintBtn=$('#btn-hint'),hintBox=$('#hint');
    const submitBtn=$('#btn-submit'),statusEl=$('#status'),bar=$('#bar');
    const modeTag=$('#modeTag'),finishTitle=$('#finish-title'),finishDesc=$('#finish-desc');
    const audioOK=$('#audio-correct'),audioNO=$('#audio-wrong');

    (async function init(){ ALL=await loadQuestions(); attachEvents(); })();

    async function loadQuestions(){
      try{
        const res=await fetch(FILE_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("fetch fail");
        const data=await res.json();
        return normalizeQuestions(data);
      }catch(e){
        console.warn("문제 로드 실패, 샘플 사용",e);
        return fallback();
      }
    }
    function fallback(){ return JSON.parse($('#questionsData').textContent); }

    // JSON 정규화(+ contains 지원)
    function normalizeQuestions(data){
      const flat=Array.isArray(data)?data.flat(Infinity):[];
      return flat.map((q,i)=>{
        const copy={...q};
        if(copy.type) copy.type=String(copy.type).toLowerCase();
        if(copy.type==='mc'){
          copy.choices=Array.isArray(copy.choices)?copy.choices:[];
          if(copy.answerIndex===undefined && copy.answer!==undefined) copy.answerIndex=Number(copy.answer);
          if(!(Number.isInteger(copy.answerIndex)&&copy.answerIndex>=0&&copy.answerIndex<copy.choices.length)){
            copy.answerIndex=-1;
          }
          delete copy.answer; delete copy.answers;
        }else{ // fill
          if(!Array.isArray(copy.answers)){
            if(Array.isArray(copy.answer)) copy.answers=copy.answer;
            else if(copy.answer!==undefined) copy.answers=[copy.answer];
            else copy.answers=[];
          }
          delete copy.answer;
          if(copy.ignoreSpaces===undefined && copy.answers.some(a=>String(a).includes(' '))) copy.ignoreSpaces=true;
          // contains 구조 보정
          if(copy.contains && typeof copy.contains==='object'){
            if(!Array.isArray(copy.contains.all)) copy.contains.all = [];
            if(!Array.isArray(copy.contains.any)) copy.contains.any = [];
          }
        }
        copy.id=i+1;
        return copy;
      });
    }

    function attachEvents(){
      $('#btn-practice').onclick=()=>start('practice');
      $('#btn-exam').onclick=()=>start('exam');
      $('#btn-exit').onclick=()=>show('home');
      $('#btn-retry-practice').onclick=()=>start('practice');
      $('#btn-retry-exam').onclick=()=>start('exam');
      $('#btn-home').onclick=()=>show('home');
      submitBtn.onclick=onSubmit;

      // 힌트 버튼: 연습모드에서만 동작
      hintBtn.onclick=()=>{
        if(MODE!=='practice') return;
        const q=PICK[idx]; if(!q||q.type==='mc') return;
        const msg = buildHint(q);
        if(msg){ hintBox.textContent=msg; hintBox.style.display=(hintBox.style.display==='none'||hintBox.style.display==='')?'block':'none'; }
        else { hintBox.style.display='none'; }
      };

      fillInput.addEventListener('keydown',e=>{ if(e.key==='Enter') onSubmit(); });
    }

    function show(w){
      home.style.display=(w==='home')?'block':'none';
      quiz.style.display=(w==='quiz')?'block':'none';
      done.style.display=(w==='done')?'block':'none';
    }

    function start(mode){
      MODE=mode; score=0; idx=0;
      PICK=pickRandom(ALL,TOTAL);
      modeTag.textContent=(MODE==='practice')?'연습모드':'실전모드';
      show('quiz'); render();
    }

    function pickRandom(arr,n){
      const c=[...arr];
      for(let i=c.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]]; }
      return c.slice(0,Math.min(n,c.length));
    }

    function render(){
      const q=PICK[idx];
      qnoEl.textContent=`${idx+1} / ${TOTAL}`;
      bar.style.width=`${((idx)/TOTAL)*100}%`;
      statusEl.textContent='';
      qtextEl.textContent=q.q||'';
      hintBox.style.display='none'; hintBox.textContent='';

      // 실전모드: 힌트 버튼 숨김, 연습모드: 주관식에서만 보이기
      if(q.type==='mc'){
        hintBtn.style.display='none';
        fillWrap.style.display='none'; mcWrap.style.display='grid'; mcWrap.innerHTML='';
        (q.choices||[]).forEach((c,i)=>{
          const div=document.createElement('label');
          div.className='choice';
          div.innerHTML=`<input type="radio" name="mc" value="${i}"><span>${c}</span>`;
          mcWrap.appendChild(div);
        });
      }else{
        mcWrap.style.display='none'; fillWrap.style.display='block'; fillInput.value='';
        hintBtn.style.display = (MODE==='practice') ? 'inline-block' : 'none';
      }
      submitBtn.disabled=false;
    }

    function onSubmit(){
      const q=PICK[idx];

      // 무응답 방지
      if(q.type==='mc'){
        const sel=document.querySelector('input[name="mc"]:checked');
        if(!sel){ statusEl.innerHTML=`<span class="bad">먼저 답을 선택해 주세요</span>`; return; }
      }else{
        const user=fillInput.value.trim();
        if(!user){ statusEl.innerHTML=`<span class="bad">먼저 정답을 입력해 주세요</span>`; return; }
      }

      const result=checkAnswer(q);
      if(result){
        audioOK.currentTime=0; audioOK.play().catch(()=>{});
        statusEl.innerHTML=`<span class="ok">딩동댕! 정답이에요</span>`;
        if(MODE==='exam'){ score+=POINTS_PER_CORRECT; autoNext(); }
        else setTimeout(nextQuestion,450);
      }else{
        audioNO.currentTime=0; audioNO.play().catch(()=>{});
        statusEl.innerHTML=`<span class="bad">땡! 다시 시도해봐요</span>`;
        if(MODE==='exam'){ autoNext(); }
        else{
          // 연습: 주관식일 때 힌트 자동 제공
          if(q.type!=='mc'){
            const msg = buildHint(q);
            if(msg){ hintBox.textContent = msg; hintBox.style.display='block'; }
            else { hintBox.style.display='none'; }
          }
        }
      }
    }

    function autoNext(){ submitBtn.disabled=true; setTimeout(nextQuestion,450); }
    function nextQuestion(){ if(idx<TOTAL-1){ idx++; render(); } else finish(); }
    function finish(){
      show('done'); bar.style.width='100%';
      if(MODE==='practice'){
        finishTitle.textContent='수고했습니다♥';
        finishDesc.textContent='연습문제를 모두 풀었어요.';
      }else{
        const maxScore=TOTAL*POINTS_PER_CORRECT;
        const percent=Math.round((score/maxScore)*100);
        finishTitle.textContent='실전 결과';
        finishDesc.innerHTML=`점수: <b>${score} / ${maxScore}</b> (${percent}%)`;
      }
    }

    // ==== 채점 & 힌트 ====
    function normalize(s,ignore){ if(typeof s!=='string') return ''; let t=s.trim().toLowerCase(); if(ignore) t=t.replace(/\s+/g,''); t=t.replace(/[.,!?:;'"()]/g,''); return t; }

    function checkAnswer(q){
      if(q.type==='mc'){
        const sel=document.querySelector('input[name="mc"]:checked'); if(!sel) return null;
        return Number(sel.value) === Number(q.answerIndex);
      }
      // fill
      const userRaw = fillInput.value; if(!userRaw?.trim()) return null;
      const user = normalize(userRaw, !!q.ignoreSpaces);
      const mode = (q.mode || (q.contains ? 'contains' : 'exact')).toLowerCase();

      if(mode==='contains'){
        const needAll = (q.contains && Array.isArray(q.contains.all)) ? q.contains.all : [];
        const needAny = (q.contains && Array.isArray(q.contains.any)) ? q.contains.any : [];
        const okAll = needAll.length ? needAll.every(k => user.includes(normalize(String(k), !!q.ignoreSpaces))) : true;
        const okAny = needAny.length ? needAny.some(k => user.includes(normalize(String(k), !!q.ignoreSpaces))) : true;
        return okAll && okAny;
      }

      if(mode==='regex' && q.pattern){
        try{ const re=new RegExp(q.pattern,'i'); return re.test(userRaw.trim()); }
        catch(e){ console.warn('regex error',e); return false; }
      }

      const list=Array.isArray(q.answers)?q.answers:[];
      return list.some(ans=>normalize(String(ans),!!q.ignoreSpaces)===user);
    }

    // 연습모드용 힌트 구성: 명시적 hint > contains 키워드 > 없음
    function buildHint(q){
      if(q.hint) return q.hint;
      if(q.contains){
        const all = Array.isArray(q.contains.all) ? q.contains.all : [];
        const any = Array.isArray(q.contains.any) ? q.contains.any : [];
        const parts=[];
        if(all.length) parts.push(`핵심키워드(모두 포함): ${all.join(', ')}`);
        if(any.length) parts.push(`힌트 키워드(하나 이상): ${any.join(', ')}`);
        if(parts.length) return parts.join(' / ');
      }
      return '';
    }
  </script>
</body>
</html>


