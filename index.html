<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>성경퀴즈게임</title>
  <style>
    :root { --maxw: 720px; --blue:#1e40af; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans KR",sans-serif}
    main{max-width:var(--maxw);margin:0 auto;padding:20px;text-align:center}
    h1{margin:8px 0 2px;font-size:clamp(28px,6vw,42px)}
    .muted{color:var(--muted);margin:0 0 16px}
    .hidden{display:none!important}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:20px;box-shadow:0 6px 30px rgba(0,0,0,.06)}
    input,select{width:100%;max-width:420px;padding:12px 14px;border:2px solid #e5e7eb;border-radius:14px;font-size:16px}
    button{cursor:pointer;border:none;border-radius:14px;padding:12px 18px;font-weight:700;background:var(--blue);color:#fff}
    .ghost{background:#e5e7eb;color:#111}
    .question{margin:16px 0;font-size:18px;line-height:1.55;text-align:left}
    .choices{display:grid;gap:10px}
    .choices button{background:#fff;color:#111;border:2px solid #e5e7eb;text-align:left;padding:14px;border-radius:14px}
    .choices button:hover{background:#f1f5f9}
    .hint{margin-top:10px;color:#1d4ed8;font-size:14px;text-align:left}
    .note{margin-top:12px;font-size:12px;color:#9ca3af}
    details.dev{margin-top:16px;text-align:left}
    details.dev summary{cursor:pointer}
  </style>
</head>
<body>
<main>
  <!-- 시작 화면 -->
  <section id="startScreen" class="card">
    <h1>성경퀴즈게임</h1>
    <p class="muted">얘들아 성경퀴즈 풀어볼까?</p>

    <p>미션키즈♥</p>
    <p><input id="playerName" type="text" maxlength="4" placeholder="이름 (최대 4글자)" /></p>
    <p>♥</p>

    <p>
      <label style="display:block;margin:6px 0 8px;">레벨 선택</label>
      <select id="level" style="max-width:260px">
        <option value="basic">말씀탐험 (연습)</option>
        <option value="real">믿음도전 (실전)</option>
      </select>
    </p>

    <p class="note">현재 불러온 문제: <span id="qcount">0</span>문항</p>
    <p><button id="startBtn">시작하기</button></p>
  </section>

  <!-- 퀴즈 화면 -->
  <section id="quizScreen" class="card hidden">
    <h2 id="quizPlayer" class="muted" style="margin-top:0;"></h2>
    <div id="questionContainer" class="question"></div>
    <div id="choicesContainer" class="choices"></div>
    <div id="hintContainer" class="hint hidden"></div>
  </section>

  <!-- 종료 화면 -->
  <section id="endScreen" class="card hidden">
    <h2 id="endMessage" style="margin-top:0;"></h2>
    <p><button id="retryBtn">다시 도전하기</button></p>
    <div class="note">소리가 작다면 무음 모드 해제 후 볼륨을 올려주세요.</div>
  </section>

  <!-- 사운드(없으면 WebAudio 오르골 톤으로 폴백) -->
  <audio id="correctSound" preload="auto"><source src="./dingdongdang.mp3" type="audio/mpeg"></audio>
  <audio id="wrongSound"   preload="auto"><source src="./orrgoll_ding.mp3" type="audio/mpeg"></audio>
  <audio id="fanfareSound" preload="auto"><source src="./fanfare.mp3" type="audio/mpeg"></audio>

  <!-- 샘플 3문항(자동 로드 실패 시만 사용되는 안전장치) -->
  <script id="questionsData" type="application/json">[
    { "q": "창세기 1장 1절: 태초에 하나님이 (      )와 (      )을 창조하시니라 / 하늘, 땅 (공백 무시)", "type": "fill", "answer": ["하늘과땅","하늘과 땅","하늘 땅"] },
    { "q": "예수님의 제자는 몇 명이었나요?", "type": "mc", "choices": ["10명","12명","70명","3명"], "answer": 1 },
    { "q": "다윗이 물리친 거인의 이름은?", "type": "mc", "choices": ["골리앗","바알","느부갓네살","사울"], "answer": 0 }
  </script>

  <script>
  // ---------- 유틸 ----------
  const byId = (id)=>document.getElementById(id);
  const normalize = (s)=> String(s??'').toLowerCase().replace(/\s+/g,'').replace(/["'“”’]/g,'');
  const shuffle = (a)=>{const r=a.slice(); for(let i=r.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];} return r;};

  // ---------- 판정 ----------
  const isCorrectMC = (q, idx)=>{
    if (typeof q.answer === 'number') return (q.answer === idx || q.answer === idx+1);
    if (typeof q.answer === 'string'){
      const opts = q.options || q.choices || [];
      return normalize(opts[idx]) === normalize(q.answer);
    }
    return false;
  };
  const isCorrectFill = (q, val)=>{
    const v = normalize(val);
    const ans = q.answer;
    if(Array.isArray(ans)) return ans.some(a=> normalize(a)===v);
    return normalize(ans) === v;
  };

  // ---------- 전처리(힌트/타입 표준화) ----------
  function preprocess(list){
    if(!Array.isArray(list)) return [];
    return list.map((raw, i)=>{
      const obj = {...raw};
      const text = (obj.q||obj.question||'').toString();
      let qText = text, hintFromSlash = '';
      const p = text.indexOf('/');
      if(p>-1){ qText = text.slice(0,p).trim(); hintFromSlash = text.slice(p+1).trim(); }
      const rawType = String(obj.type||'').toLowerCase();
      let type = ['fill','short','text','주관식'].includes(rawType) ? 'fill' : 'mc';
      const options = Array.isArray(obj.choices) ? obj.choices : (Array.isArray(obj.options)? obj.options : []);
      let answer = obj.answer;
      if(type==='mc' && typeof answer==='string' && /^\d+$/.test(answer)) answer = parseInt(answer,10);
      if(type==='fill' && typeof answer==='string' && answer.includes(',')) answer = answer.split(',').map(s=>s.trim());
      const hint = (obj.hint && String(obj.hint).trim()) || hintFromSlash;
      return { id: obj.id || (i+1), type, question: qText, options, answer, hint };
    });
  }

  // ---------- 데이터 로드(자동) ----------
  let QUESTIONS = [];
  const DEFAULT_URL = './questions_tuned_70.json'; // 같은 폴더의 70문항 JSON

  async function autoLoadQuestions(){
    // 1) 동일 저장소의 JSON 자동 로드
    try{
      const res = await fetch(DEFAULT_URL, {cache:'no-store'});
      if(res.ok){
        const data = await res.json();
        if(Array.isArray(data) && data.length){
          QUESTIONS = preprocess(data);
          byId('qcount').textContent = String(QUESTIONS.length);
          return;
        }
      }
    }catch(e){ console.warn('자동 로드 실패(무시):', e); }

    // 2) 실패 시 내장 샘플 사용
    try{
      const raw = byId('questionsData')?.textContent || '[]';
      const arr = JSON.parse(raw);
      QUESTIONS = Array.isArray(arr) ? preprocess(arr) : [];
    }catch(e){ QUESTIONS = []; }
    byId('qcount').textContent = String(QUESTIONS.length||0);
  }
  window.addEventListener('DOMContentLoaded', autoLoadQuestions);

  // ---------- 사운드(파일 우선, WebAudio 폴백) ----------
  let audioCtx=null;
  function ensureAudio(){ try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch(e){} }
  window.addEventListener('pointerdown', ensureAudio, {once:true});
  window.addEventListener('touchstart', ensureAudio, {once:true});
  function tone(freq,dur,type='sine',start=0,vol=0.22){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime + start;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0, t0);
    g.gain.linearRampToValueAtTime(vol, t0+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(t0); osc.stop(t0+dur+0.05);
  }
  function synthChime(){ ensureAudio(); tone(523.25,0.5,'sine',0,0.24); tone(659.25,0.45,'sine',0.18,0.22); tone(783.99,0.4,'sine',0.36,0.20); }
  function synthWrong(){ ensureAudio(); tone(880.00,0.45,'sine',0,0.22); tone(698.46,0.45,'sine',0.18,0.22); tone(523.25,0.45,'sine',0.36,0.22); }
  function synthFanfare(){ ensureAudio(); [[523.25,659.25,783.99],[587.33,739.99,880.00],[659.25,783.99,987.77]].forEach((ch,i)=> ch.forEach((f,j)=> tone(f,0.35,'square',i*0.35,0.18-j*0.03))); }
  function playSound(id){
    const el = byId(id);
    const fb = ()=> (id==='correctSound'?synthChime(): id==='wrongSound'?synthWrong():synthFanfare());
    if(!el) return fb();
    try{
      el.currentTime=0;
      const p=el.play();
      if(p && typeof p.then==='function'){ p.then(()=>{}).catch(fb); setTimeout(()=>{ if(el.paused) fb(); }, 300); }
      else{ setTimeout(()=>{ if(el.paused) fb(); }, 150); }
    }catch(e){ fb(); }
  }

  // ---------- 게임 로직 ----------
  let current=0, score=0, level='basic', playerName='';
  let wrongCount=0, hintShown=false;

  function startGame(){
    ensureAudio();
    playerName = byId('playerName').value || '미션키즈';
    level = byId('level').value;
    byId('quizPlayer').textContent = `♥ 이름 → ${playerName} ♥`;

    byId('startScreen').classList.add('hidden');
    byId('endScreen').classList.add('hidden');
    byId('quizScreen').classList.remove('hidden');

    score=0; current=0; wrongCount=0; hintShown=false;
    QUESTIONS = shuffle(QUESTIONS.slice());
    renderQuestion();
  }

  function renderQuestion(){
    if(current>=QUESTIONS.length) return endGame();
    const q = QUESTIONS[current];
    byId('questionContainer').textContent = `${current+1}. ${q.question}`;
    const choices = byId('choicesContainer'); choices.innerHTML='';
    const hintBox = byId('hintContainer'); hintBox.classList.add('hidden'); hintBox.textContent='';

    if(q.type==='mc'){
      (q.options||[]).forEach((c,i)=>{
        const btn=document.createElement('button');
        btn.textContent=`${i+1}) ${c}`;
        btn.onclick=()=> handleAnswer(isCorrectMC(q,i));
        choices.appendChild(btn);
      });
    }else{
      const input=document.createElement('input'); input.type='text'; input.autocomplete='off';
      input.placeholder = q.hint ? `힌트: ${q.hint}` : '정답을 입력하세요';
      const ok=document.createElement('button'); ok.className='ghost'; ok.textContent='확인';
      ok.onclick=()=> handleAnswer(isCorrectFill(q,input.value));
      input.addEventListener('keydown',e=>{ if(e.key==='Enter') ok.click(); });
      choices.append(input, ok);

      if(level==='basic' && q.hint && hintShown){
        hintBox.textContent=`힌트: ${q.hint}`;
        hintBox.classList.remove('hidden');
      }
      setTimeout(()=>input.focus(),0);
    }
  }

  function handleAnswer(correct){
    if(level==='basic'){
      if(correct){ playSound('correctSound'); score++; current++; wrongCount=0; hintShown=false; renderQuestion(); }
      else{ playSound('wrongSound'); wrongCount++; if(!hintShown && wrongCount>=1){ hintShown=true; renderQuestion(); } }
    }else{
      if(correct){ playSound('correctSound'); score++; } else { playSound('wrongSound'); }
      current++; wrongCount=0; hintShown=false; renderQuestion();
    }
  }

  function endGame(){
    byId('quizScreen').classList.add('hidden');
    byId('endScreen').classList.remove('hidden');
    const total=Math.max(1,QUESTIONS.length);
    byId('endMessage').textContent=`축하합니다! ${Math.round(score/total*100)}점입니다.`;
    playSound('fanfareSound');
  }

  function restartGame(){
    byId('endScreen').classList.add('hidden');
    byId('startScreen').classList.remove('hidden');
  }

  byId('startBtn')?.addEventListener('click', startGame);
  byId('retryBtn')?.addEventListener('click', restartGame);
  </script>

  <!-- 필요하면 수동 불러오기 UI(개발자용) -->
  <details class="dev">
    <summary>⚙️ 개발자 옵션 (수동으로 JSON 불러오기)</summary>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px;">
      <input id="qfile" type="file" accept="application/json" />
      <input id="qurl" type="url" placeholder="https://.../questions_tuned_70.json" style="flex:1; min-width:240px;" />
      <button id="qurlLoad" class="ghost" onclick="(async()=>{const url=(document.getElementById('qurl')?.value||'').trim(); if(!url) return alert('URL 입력'); try{const r=await fetch(url,{cache:'no-store'}); const d=await r.json(); QUESTIONS=preprocess(d); document.getElementById('qcount').textContent=String(QUESTIONS.length); alert('불러오기 완료');}catch(e){alert('가져오기 실패:'+e);} })()">불러오기</button>
    </div>
  </details>
</main>
</body>
</html>
